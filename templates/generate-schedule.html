{% extends "base.html" %} {% block content %} {% import "macros/icons.html" as
icons %} {% include "header.html" %} {% if data %} {% include "dashboard.html" %} {% else %}
<div class="upload-container">
  <form class="upload-form" action="/generate-schedule" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <label for="file-upload" class="upload-zone">
      <span class="upload-icon"> {{ icons.UploadIcon(32) }} </span>

      <div class=" upload-text-container">
        <span class="upload-text">Drag & Drop or <span class="hl ">Choose files</span> to upload</span>
        <span class="upload-text-drag">.xls, .xlsx</span>
      </div>

      <input id="file-upload" name="files" type="file" multiple class="upload-zone-input" accept=".xls,.xlsx" />
    </label>

    <div id="file-error-message" class="file-error"></div>
    <div id="file-list-container"></div>

    <div class="upload-form-actions">
      {% if show_cancel %}
      <button type="button" id="cancel-btn" class="btn btn--secondary">Cancel</button>
      {% endif %}
      <button id="process-btn" type="submit" class="btn btn--primary" disabled>
        <span class="btn-text"> Process {{ icons.SendIcon(16) }} </span>
        <span class="btn-loader">{{ icons.LoaderIcon(16) }}</span>
      </button>
    </div>
  </form>
</div>

{% endif %}

{% include "zoom-assignment-modal.html" %}

<script type="module" nonce="{{ csp_nonce }}">
  import { TableManager } from "/static/js/table-manager.js";
  import { notificationManager } from "/static/js/notification.js";
  import "/static/js/zoom-assignment.js";

  // Hacer notificationManager disponible globalmente
  window.notificationManager = notificationManager;

  {% if data %}
  document.addEventListener("DOMContentLoaded", () => {
    TableManager.init("#data-preview-table");
  });
  {% endif %}

  // Mostrar notificaciones de errores de carga si existen
  {% if upload_errors and upload_errors | length > 0 %}
  document.addEventListener("DOMContentLoaded", () => {
    const uploadErrors = {{ upload_errors | tojson
  }};
  uploadErrors.forEach(error => {
    notificationManager.warning(error);
  });
  });
  {% endif %}

  const fileIconHtml = `{{ icons.FileIcon(16) }}`;
  const trashIconHtml = `{{ icons.TrashIcon(16) }}`;

  let fileInput = document.getElementById("file-upload");
  const listContainer = document.getElementById("file-list-container");
  const uploadForm = document.querySelector(".upload-form");
  const processButton = document.getElementById("process-btn");
  const cancelButton = document.getElementById("cancel-btn");
  const errorMessageEl = document.getElementById("file-error-message");
  const uploadZone = document.querySelector(".upload-zone");

  listContainer.style.display = "none";
  errorMessageEl.style.display = "none";

  const MAX_FILES = 5;
  const MAX_TOTAL_SIZE = 5 * 1024 * 1024;
  const ALLOWED_EXTENSIONS = [".xls", ".xlsx"];

  let fileStore = new DataTransfer();

  // Función para deshabilitar/habilitar elementos de carga
  function setUploadDisabled(disabled) {
    if (disabled) {
      uploadZone.classList.add("disabled");
    } else {
      uploadZone.classList.remove("disabled");
    }
  }

  function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i];
  }

  function showError(message) {
    // Usar notificaciones modernas
    if (window.notificationManager) {
      window.notificationManager.error(message);
      errorMessageEl.style.display = "none";
    } else {
      // Fallback al método anterior si notificationManager no está disponible
      errorMessageEl.style.display = "block";
      errorMessageEl.textContent = message;
    }
  }

  function clearError() {
    errorMessageEl.textContent = "";
    errorMessageEl.style.display = "none";
  }

  function clearFiles() {
    fileStore = new DataTransfer();
    updateFileInput();
    renderFileList();
    clearError();
  }

  function renderFileList() {
    listContainer.innerHTML = "";
    const files = fileStore.files;

    if (files.length === 0) {
      listContainer.style.display = "none";
      processButton.disabled = true;
      return;
    }

    processButton.disabled = false;
    listContainer.style.display = "block";

    const fileList = document.createElement("ul");
    fileList.className = "file-list";

    Array.from(files).forEach((file, index) => {
      const fileItem = document.createElement("li");
      fileItem.className = "file-item";

      const fileDetails = document.createElement("div");
      fileDetails.className = "file-details";

      const fileIcon = document.createElement("span");
      fileIcon.className = "file-icon";
      fileIcon.innerHTML = fileIconHtml;

      const fileName = document.createElement("span");
      fileName.className = "file-name";
      fileName.textContent = file.name;
      fileName.title = file.name;

      const fileSize = document.createElement("span");
      fileSize.className = "file-size";
      fileSize.textContent = formatBytes(file.size);

      fileDetails.appendChild(fileIcon);
      fileDetails.appendChild(fileName);
      fileDetails.appendChild(fileSize);

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "remove-file-btn";
      removeBtn.dataset.index = index;
      removeBtn.setAttribute("aria-label", `Remove file ${file.name}`);
      removeBtn.innerHTML = trashIconHtml;

      fileItem.appendChild(fileDetails);
      fileItem.appendChild(removeBtn);

      fileList.appendChild(fileItem);
    });

    listContainer.appendChild(fileList);

    document.querySelectorAll(".remove-file-btn").forEach((btn) => {
      btn.addEventListener("click", handleRemoveFile);
    });
  }

  function handleRemoveFile(event) {
    clearError();
    const indexToRemove = parseInt(event.currentTarget.dataset.index, 10);
    const newStore = new DataTransfer();

    Array.from(fileStore.files).forEach((file, index) => {
      if (index !== indexToRemove) {
        newStore.items.add(file);
      }
    });

    fileStore = newStore;
    updateFileInput();
    renderFileList();
  }

  // Funcionalidad de Drag & Drop
  if (uploadZone) {
    // Prevenir el comportamiento por defecto para los eventos de drag
    ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Resaltar la zona de drop cuando un archivo está sobre ella
    ["dragenter", "dragover"].forEach((eventName) => {
      uploadZone.addEventListener(eventName, highlight, false);
    });

    ["dragleave", "drop"].forEach((eventName) => {
      uploadZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      uploadZone.classList.add("highlight");
    }

    function unhighlight() {
      uploadZone.classList.remove("highlight");
    }

    uploadZone.addEventListener("drop", function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      const newStore = new DataTransfer();
      Array.from(files).forEach(file => {
        newStore.items.add(file);
      });

      fileStore = newStore;
      validateAndRenderFiles();
    }, false);
  }

  function validateAndRenderFiles() {
    clearError();

    const files = Array.from(fileStore.files);

    if (files.length === 0) {
      // FIX 1: Llamar a updateFileInput para limpiar el input
      updateFileInput();
      renderFileList();
      return;
    }

    // Validar cantidad máxima de archivos
    if (files.length > MAX_FILES) {
      showError(`You can only upload a maximum of ${MAX_FILES} files.`);
      const newStore = new DataTransfer();
      files.slice(0, MAX_FILES).forEach(file => {
        newStore.items.add(file);
      });
      fileStore = newStore;
      updateFileInput();
      renderFileList();
      return;
    }

    // Validar tamaño total
    const totalSize = files.reduce((acc, file) => acc + file.size, 0);
    if (totalSize > MAX_TOTAL_SIZE) {
      showError(`Total file size cannot exceed ${formatBytes(MAX_TOTAL_SIZE, 0)}.`);

      // FIX 2: Resetear el store y el input a un estado vacío y válido
      fileStore = new DataTransfer();
      updateFileInput();
      renderFileList();

      return;
    }

    /// Validar extensiones y filtrar archivos inválidos
    const validFiles = [];
    const invalidFiles = [];

    files.forEach(file => {
      const ext = file.name.substring(file.name.lastIndexOf(".")).toLowerCase();
      if (ALLOWED_EXTENSIONS.includes(ext)) {
        validFiles.push(file);
      } else {
        invalidFiles.push(file.name);
      }
    });

    // Mostrar error si hay archivos inválidos
    if (invalidFiles.length > 0) {
      showError(`Invalid file type${invalidFiles.length > 1 ? 's' : ''}: ${invalidFiles.join(', ')}. Only .xls and .xlsx are allowed.`);
    }


    // Actualizar store solo con archivos válidos
    const newStore = new DataTransfer();
    validFiles.forEach(file => {
      newStore.items.add(file);
    });

    fileStore = newStore;
    updateFileInput();
    renderFileList();
  }

  // Función auxiliar para actualizar el input file
  function updateFileInput() {
    // Crear un nuevo input file temporal
    const newInput = document.createElement('input');
    newInput.type = 'file';
    newInput.name = 'files';
    newInput.multiple = true;

    // Transferir los archivos al nuevo input
    const dataTransfer = new DataTransfer();
    Array.from(fileStore.files).forEach(file => {
      dataTransfer.items.add(file);
    });
    newInput.files = dataTransfer.files;

    // Reemplazar el input original con el nuevo
    const oldInput = document.getElementById('file-upload');
    oldInput.parentNode.replaceChild(newInput, oldInput);
    newInput.id = 'file-upload';
    newInput.className = 'upload-zone-input';
    newInput.accept = '.xls,.xlsx';
    newInput.style.display = 'none';

    // Actualizar la referencia global
    fileInput = newInput;

    // Re-attach event listener
    fileInput.addEventListener('change', handleFileInputChange);
  }

  // Handler para el input file
  function handleFileInputChange() {
    const newFiles = Array.from(fileInput.files);

    const newStore = new DataTransfer();
    newFiles.forEach(file => {
      newStore.items.add(file);
    });

    fileStore = newStore;
    updateFileInput();
    validateAndRenderFiles();
  }

  // Inicializar event listener
  fileInput.addEventListener('change', handleFileInputChange);

  if (uploadForm && processButton) {
    uploadForm.addEventListener("submit", (e) => {
      if (processButton.disabled) {
        e.preventDefault();
        return;
      }

      // Verificar que hay archivos válidos antes de enviar
      const validFiles = Array.from(fileStore.files).filter(file => {
        const ext = file.name.substring(file.name.lastIndexOf(".")).toLowerCase();
        return ALLOWED_EXTENSIONS.includes(ext);
      });

      if (validFiles.length === 0) {
        e.preventDefault();
        showError("Please select valid Excel files (.xls, .xlsx) to process.");
        return;
      }

      processButton.disabled = true;
      processButton.classList.add("is-loading");
      setUploadDisabled(true);

      // Deshabilitar botón Cancel durante el procesamiento
      if (cancelButton) {
        cancelButton.disabled = true;
      }

      document.querySelectorAll(".remove-file-btn").forEach((btn) => {
        btn.disabled = true;
      });
    });
  }

  // Manejar botón Cancel
  if (cancelButton) {
    cancelButton.addEventListener("click", () => {
      // Solo permitir cancelar si no está procesando
      if (processButton.disabled && processButton.classList.contains("is-loading")) {
        return; // No hacer nada si está procesando
      }

      // Si hay archivos seleccionados, limpiarlos
      if (fileStore.files.length > 0) {
        clearFiles();
      } else {
        // Si no hay archivos, redirigir a la vista del horario
        window.location.href = "/generate-schedule";
      }
    });
  }

  window.addEventListener("pageshow", function (event) {
    if (processButton) {
      processButton.classList.remove("is-loading");
      setUploadDisabled(false);

      if (fileStore.files.length === 0) {
        processButton.disabled = true;
      } else {
        processButton.disabled = false;
      }
    }
    if (cancelButton) {
      cancelButton.disabled = false;
    }
    document.querySelectorAll(".remove-file-btn").forEach((btn) => {
      btn.disabled = false;
    });
  });
</script>

<style nonce="{{ csp_nonce }}">
  .upload-container {
    max-width: 24rem;
  }

  /* .upload-zone {
    transition: all 0.3s ease;
  } */

  .upload-zone.highlight {
    background-color: var(--color-hover-upload);
  }

  .upload-zone.disabled {
    opacity: 0.6;
    pointer-events: none;
  }

  .upload-text-container {
    text-align: center;

  }

  .upload-text {
    color: var(--color-text-primary);
  }

  .upload-text .hl {
    color: var(--color-border-upload);
    font-weight: 500;
  }

  .upload-text-drag {
    display: block;
    font-size: 14px;
    color: #666;
  }
</style>

{% endblock %}